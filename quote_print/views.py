from django.shortcuts import render
from django.http import HttpResponse
from django.conf import settings
from pamo.conecctions_shopify import ConnectionsShopify
from pamo.constants import *
from pamo.queries import *
from datetime import timedelta, datetime
import re

def index(request):
    ConnectionsShopify()
    shopify = ConnectionsShopify()
    response = shopify.request_graphql(GET_DRAFT_ORDERS)
    res  = response.json()
    for i in range(len(res['data']['draftOrders']['edges'])):
        res['data']['draftOrders']['edges'][i]['node']['createdAt'] = datetime.strptime((res['data']['draftOrders']['edges'][i]['node']['createdAt']), '%Y-%m-%dT%H:%M:%SZ').strftime('%Y-%m-%d')
        res['data']['draftOrders']['edges'][i]['node']['updatedAt'] = datetime.strptime((res['data']['draftOrders']['edges'][i]['node']['updatedAt']), '%Y-%m-%dT%H:%M:%SZ').strftime('%Y-%m-%d')
        res['data']['draftOrders']['edges'][i]['node']['name'] = int(res['data']['draftOrders']['edges'][i]['node']['name'][2:])
    data = {"table" :res['data']['draftOrders']['edges'], 'url_base':settings.BASE_URL}
    return render(request, 'table_draft_orders.html', data)

def print_drafr(request,id):
    # ConnectionsShopify()
    # shopify = ConnectionsShopify()
    # query = GET_DRAFT_ORDER.format(id)
    # response = shopify.request_graphql(query)
    # date_update = datetime.strptime(response.json()['data']['draftOrders']['edges'][0]['node']['updatedAt'][0:10], '%Y-%m-%d')
    # plazo = (date_update + timedelta(days=10)).strftime('%d/%m/%Y')
    # draft = response.json()['data']['draftOrders']['edges'][0]['node']
    # try:
    #     res = re.search(r'\[(\d+)\]' ,draft['customer']['metafields']['edges'][0]['node']['value'])
    #     num = res.group(1)
    # except:
    #     num = None
    # for i in draft['lineItems']['edges']:
    #     try:
    #         i['sku'] = i['node']['product']['variants']['edges'][0]['node']['sku']
    #         i['scr'] = i['node']['product']['images']['edges'][0]['node']['originalSrc']
    #     except:
    #         pass
    # data = {'info':draft, 'plazo':plazo, 'update': date_update.strftime('%d/%m/%Y'), 'nit':num}

    # data = {'info': {'id': 'gid://shopify/DraftOrder/1136648061205', 'name': '#D258', 'totalPrice': '16800.00', 'createdAt': '2023-10-10T22:43:39Z', 'updatedAt': '2023-10-10T22:43:39Z', 'appliedDiscount': None, 'customer': {'displayName': 'Juan Camilo Garzon', 'email': None, 'defaultAddress': {'company': '', 'phone': '+573058602015'}, 'metafields': {'edges': []}}, 'invoiceUrl': 'https://www.pamo.co/61785079974/invoices/3ebdb5d934f778aef08b6bff84569809', 'lineItems': {'edges': [{'node': {'title': 'Tubo Redondo de Ducha de Techo en Acero de 20 cm', 'originalUnitPrice': '8400.00', 'quantity': 2, 'product': {'images': {'edges': [{'node': {'originalSrc': 'https://cdn.shopify.com/s/files/1/0617/8507/9974/files/1_99c95b09-4c5c-452e-b2ae-05ed59e2e85e.png?v=1695904438'}}]}, 'variants': {'edges': [{'node': {'sku': 'DF-1004'}}]}}}, 'sku': 'DF-1004', 'scr': 'https://cdn.shopify.com/s/files/1/0617/8507/9974/files/1_99c95b09-4c5c-452e-b2ae-05ed59e2e85e.png?v=1695904438'}]}}, 'plazo': '20/10/2023', 'update': '10/10/2023', 'nit': None}
    data = {'info': {'id': 'gid://shopify/DraftOrder/1136607363349', 'name': '#D253', 'totalPrice': '3455900.00', 'createdAt': '2023-10-10T14:14:31Z', 'updatedAt': '2023-10-10T14:14:32Z', 'appliedDiscount': None, 'customer': {'displayName': 'HS2E ARQUITECTURA SAS', 'email': 'irene@hs2e.co', 'defaultAddress': {'company': 'HS2E ARQUITECTURA SAS', 'phone': '-3108545065-'}, 'metafields': {'edges': []}}, 'invoiceUrl': 'https://www.pamo.co/61785079974/invoices/a6b2f69fa73d8a11089c58f4fa470f22', 'lineItems': {'edges': [{'node': {'title': 'Mono-mando Grifería Lavaplatos Vertical Dusseldorf', 'originalUnitPrice': '450000.00', 'quantity': 1, 'product': {'images': {'edges': [{'node': {'originalSrc': 'https://cdn.shopify.com/s/files/1/0617/8507/9974/products/D_885341-MCO31550864324_072019-O.jpg?v=1693033442'}}]}, 'variants': {'edges': [{'node': {'sku': '10600801'}}]}}}, 'sku': '10600801', 'scr': 'https://cdn.shopify.com/s/files/1/0617/8507/9974/products/D_885341-MCO31550864324_072019-O.jpg?v=1693033442'}, {'node': {'title': 'Acabado gri satin mate', 'originalUnitPrice': '185000.00', 'quantity': 1, 'product': None}}, {'node': {'title': 'Griferia Monocontrol Cambridge Baja Cromada', 'originalUnitPrice': '235700.00', 'quantity': 1, 'product': {'images': {'edges': [{'node': {'originalSrc': 'https://cdn.shopify.com/s/files/1/0617/8507/9974/files/HS-3030-1.jpg?v=1695937752'}}]}, 'variants': {'edges': [{'node': {'sku': 'HS-3030-1'}}]}}}, 'sku': 'HS-3030-1', 'scr': 'https://cdn.shopify.com/s/files/1/0617/8507/9974/files/HS-3030-1.jpg?v=1695937752'}, {'node': {'title': 'Acabado grife corta hs-3030 satin mate', 'originalUnitPrice': '75000.00', 'quantity': 1, 'product': None}}, {'node': {'title': 'Manija Migliore 7.5x7 CM Cromada', 'originalUnitPrice': '77100.00', 'quantity': 4, 'product': {'images': {'edges': [{'node': {'originalSrc': 'https://cdn.shopify.com/s/files/1/0617/8507/9974/products/D_749042-MCO53986995985_022023-F.jpg?v=1694193111'}}]}, 'variants': {'edges': [{'node': {'sku': 'TXP-1309'}}]}}}, 'sku': 'TXP-1309', 'scr': 'https://cdn.shopify.com/s/files/1/0617/8507/9974/products/D_749042-MCO53986995985_022023-F.jpg?v=1694193111'}, {'node': {'title': 'Acabado manijas satin mate', 'originalUnitPrice': '50000.00', 'quantity': 4, 'product': None}}, {'node': {'title': 'Pico De Tina Cuadrado Recto Bronce', 'originalUnitPrice': '112900.00', 'quantity': 2, 'product': {'images': {'edges': [{'node': {'originalSrc': 'https://cdn.shopify.com/s/files/1/0617/8507/9974/files/1_fb887121-1422-41d5-a07e-44c5da05d845.png?v=1695996735'}}]}, 'variants': {'edges': [{'node': {'sku': 'HS-2141'}}]}}}, 'sku': 'HS-2141', 'scr': 'https://cdn.shopify.com/s/files/1/0617/8507/9974/files/1_fb887121-1422-41d5-a07e-44c5da05d845.png?v=1695996735'}, {'node': {'title': 'Acabado cuello recto lavamanos satin mate', 'originalUnitPrice': '75000.00', 'quantity': 2, 'product': None}}, {'node': {'title': 'Grifería Lavaplatos Cuello Flexible Cromada Original Pamo', 'originalUnitPrice': '110000.00', 'quantity': 1, 'product': {'images': {'edges': [{'node': {'originalSrc': 'https://cdn.shopify.com/s/files/1/0617/8507/9974/files/PAMO_F20215_6c1c77fc-08c9-4c5f-90e3-40862d7615ee.jpg?v=1695839318'}}]}, 'variants': {'edges': [{'node': {'sku': 'PAMO_F20215'}}]}}}, 'sku': 'PAMO_F20215', 'scr': 'https://cdn.shopify.com/s/files/1/0617/8507/9974/files/PAMO_F20215_6c1c77fc-08c9-4c5f-90e3-40862d7615ee.jpg?v=1695839318'}, {'node': {'title': 'Acabado grife flexible', 'originalUnitPrice': '80000.00', 'quantity': 1, 'product': None}}, {'node': {'title': 'Rejilla Acero Rectangular (20 X 10)cm Para Piso', 'originalUnitPrice': '63500.00', 'quantity': 3, 'product': {'images': {'edges': [{'node': {'originalSrc': 'https://cdn.shopify.com/s/files/1/0617/8507/9974/products/D_821165-MCO44992661043_022021-F.jpg?v=1694193713'}}]}, 'variants': {'edges': [{'node': {'sku': 'HC20002'}}]}}}, 'sku': 'HC20002', 'scr': 'https://cdn.shopify.com/s/files/1/0617/8507/9974/products/D_821165-MCO44992661043_022021-F.jpg?v=1694193713'}, {'node': {'title': 'Desagüe De Lujo Tipo Push Para Lavamanos 1 ¼', 'originalUnitPrice': '32000.00', 'quantity': 1, 'product': {'images': {'edges': [{'node': {'originalSrc': 'https://cdn.shopify.com/s/files/1/0617/8507/9974/files/PAMO_P04.jpg?v=1695842779'}}]}, 'variants': {'edges': [{'node': {'sku': 'PAMO_P04'}}]}}}, 'sku': 'PAMO_P04', 'scr': 'https://cdn.shopify.com/s/files/1/0617/8507/9974/files/PAMO_P04.jpg?v=1695842779'}, {'node': {'title': 'Acabodo push satin mate', 'originalUnitPrice': '33000.00', 'quantity': 4, 'product': None}}, {'node': {'title': 'Grifería de Baño de Pared Monocontrol Drito  21x23', 'originalUnitPrice': '428600.00', 'quantity': 1, 'product': {'images': {'edges': [{'node': {'originalSrc': 'https://cdn.shopify.com/s/files/1/0617/8507/9974/files/HS-A03.png?v=1695738008'}}]}, 'variants': {'edges': [{'node': {'sku': 'HS-A03'}}]}}}, 'sku': 'HS-A03', 'scr': 'https://cdn.shopify.com/s/files/1/0617/8507/9974/files/HS-A03.png?v=1695738008'}, {'node': {'title': 'Acabodo grife tina', 'originalUnitPrice': '110000.00', 'quantity': 1, 'product': None}}, {'node': {'title': 'Grifería Monocontrol Ducha Cuadrada Original Pamo', 'originalUnitPrice': '150000.00', 'quantity': 1, 'product': {'images': {'edges': [{'node': {'originalSrc': 'https://cdn.shopify.com/s/files/1/0617/8507/9974/files/PAMO_FS002.jpg?v=1695907088'}}]}, 'variants': {'edges': [{'node': {'sku': 'PAMO_FS002'}}]}}}, 'sku': 'PAMO_FS002', 'scr': 'https://cdn.shopify.com/s/files/1/0617/8507/9974/files/PAMO_FS002.jpg?v=1695907088'}, {'node': {'title': 'Acabado grife ducha cuadra', 'originalUnitPrice': '70000.00', 'quantity': 1, 'product': None}}, {'node': {'title': 'Regadera Slim Cuadrada Metálica 12 Pulgadas Original Pamo', 'originalUnitPrice': '85000.00', 'quantity': 1, 'product': {'images': {'edges': [{'node': {'originalSrc': 'https://cdn.shopify.com/s/files/1/0617/8507/9974/files/Disenosintitulo_7.jpg?v=1695848993'}}]}, 'variants': {'edges': [{'node': {'sku': 'PAMO_SQ033'}}]}}}, 'sku': 'PAMO_SQ033', 'scr': 'https://cdn.shopify.com/s/files/1/0617/8507/9974/files/Disenosintitulo_7.jpg?v=1695848993'}, {'node': {'title': 'Acado regadera de 30 satin mate', 'originalUnitPrice': '110000.00', 'quantity': 1, 'product': None}}, {'node': {'title': 'Moderno Tubo de Ducha Cuadrado de Acero Inoxidable Cromado', 'originalUnitPrice': '62900.00', 'quantity': 1, 'product': {'images': {'edges': [{'node': {'originalSrc': 'https://cdn.shopify.com/s/files/1/0617/8507/9974/files/1_0dc82e2c-dfc5-4d28-b431-4dc001fedb9a.png?v=1695854281'}}]}, 'variants': {'edges': [{'node': {'sku': '30*18*400'}}]}}}, 'sku': '30*18*400', 'scr': 'https://cdn.shopify.com/s/files/1/0617/8507/9974/files/1_0dc82e2c-dfc5-4d28-b431-4dc001fedb9a.png?v=1695854281'}]}}, 'plazo': '20/10/2023', 'update': '10/10/2023', 'nit': None}
    return render(request, 'print.html', data)